#!/bin/bash
echo 'Description: container on ecs cluster'
echo ''
echo 'Resources:'
echo '' 
echo '  Task:'
echo '    Type: AWS::ECS::TaskDefinition'
echo '    Properties:'
echo '      Family: '$3''
echo '      Cpu: 256'
echo '      Memory: 512'
echo '      NetworkMode: awsvpc'
echo '      RequiresCompatibilities:'
echo '        - FARGATE'
echo '      ExecutionRoleArn: !ImportValue ECSTaskExecutionRole'
echo '      ContainerDefinitions:'
echo '        - Name: web-ui-gw'
echo '         Image: '$1''
echo '          Cpu: 256'
echo '          Memory: 512'
echo '          PortMappings:'
echo '            - ContainerPort: '$2''
echo '              Protocol: tcp'
echo '          '
echo ''
echo '  Service:'
echo '    Type: AWS::ECS::Service'
echo '    DependsOn: ListenerRule'
echo '    Properties:'
echo '      ServiceName: web-ui-gw-service'
echo '      TaskDefinition: !Ref Task'
echo '      Cluster: !ImportValue 'ECSCluster''
echo '      LaunchType: FARGATE'
echo '      DesiredCount: 1'
echo '      DeploymentConfiguration:'
echo '        MaximumPercent: 100'
echo '        MinimumHealthyPercent: 70'
echo '      NetworkConfiguration:'
echo '        AwsvpcConfiguration:'
echo '          AssignPublicIp: ENABLED'
echo '          Subnets:'
echo '            - !ImportValue Subnet1ECS'
echo '          SecurityGroups:'
echo '            - !ImportValue ContainerSecurityGroup'
echo '      LoadBalancers:'
echo '        - ContainerName: web-ui-gw'
echo '          ContainerPort: '$2''
echo '          TargetGroupArn: !Ref TargetGroup'
echo ''
echo '  TargetGroup:'
echo '    Type: AWS::ElasticLoadBalancingV2::TargetGroup'
echo '    Properties:'
echo '      Name: web-ui-gw-tg'
echo '      VpcId: !ImportValue VPC'
echo '      Port: 80'
echo '      Protocol: HTTP'
echo '      Matcher:'
echo '        HttpCode: 200-299'
echo '      HealthCheckIntervalSeconds: 10'
echo '      HealthCheckPath: /stat'
echo '      HealthCheckProtocol: HTTP'
echo '      HealthCheckTimeoutSeconds: 5'
echo '      HealthyThresholdCount: 10'
echo '      TargetType: ip'
echo ''
echo '  ListenerRule:'
echo '    Type: AWS::ElasticLoadBalancingV2::ListenerRule'
echo '    Properties:'
echo '      ListenerArn: !ImportValue Listener'
echo '      Priority: 2'
echo '      Conditions:'
echo '        - Field: path-pattern'
echo '         Values: '
echo '            - /'
echo '      Actions:'
echo '        - TargetGroupArn: !Ref TargetGroup'
echo '          Type: forward'
echo ''
echo ''
echo 'Outputs:'
echo ''
echo '  ApiEndpoint:'
echo '    Description: web-ui-gw API Endpoint'
echo '    Value: !Join ['', ['http://', !ImportValue DomainName, '/']]'
echo '    Export:'
echo '      Name: 'web-ui-gwEndpoint''
echo ''
echo '  TargetGroup:'
echo '    Description: TargetGroup for future tasks'
echo '    Value: !Ref TargetGroup'
echo '    Export:'
echo '       Name: "TargetGroup"'

